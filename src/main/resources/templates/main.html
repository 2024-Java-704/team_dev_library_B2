<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<link rel="stylesheet" type="text/css" href="/css/calendar.css">
	<title>メインページ</title>
</head>

<body>

	<header th:replace="userHeader"></header>
	
	<br>
	
	<div th:if="${errorList}"} >
		<ul class="error">
			<li th:each="err:${errorList}" th:text="${err}"></li>
		</ul>
	</div>


	<!--	検索欄		-->
	<form action="/library/search" method="get">
		<input class="RoundedCornerTextBox" type="text" name="keyword" placeholder="フリーワード検索">
		<button>検索</button>
	</form>

	<br>
	
	<details  class="details">
	<summary class="details-summary">詳細検索</summary>
	<div class="details-content">
	<form action="/library/search" method="get">
		<table border="1">
			<tr>
				<th>タイトル</th>
				<td><input  class="RoundedCornerTextBox" type="text" name="name"></td>
			</tr>
			<tr>
				<th>著者</th>
				<td><input class="RoundedCornerTextBox" type="text" name="author"></td>
			</tr>
			<tr>
				<th>出版社</th>
				<td><input class="RoundedCornerTextBox" type="text" name="publisher"></td>
			</tr>
			<tr>
				<th>カテゴリー</th>
				<td>
					<select name="categoryId" size="1">
						<option value="0" label="選択なし" selected></option>
						<option th:each="category:${categories}" th:value="${category.id}">[[${category.name}]]</option>
					</select>
				</td>
			</tr>
			<tr>
				<th>サブカテゴリー</th>
				<td>
					<select name="subCategoryId" size="1">
						<option value="0" label="選択なし" selected></option>
						<option th:each="subCategory:${subCategories}" th:value="${subCategory.id}">
							[[${subCategory.name}]]</option>
					</select>
				</td>
			</tr>
		</table>
		<button>検索</button>
	</form>
	</div>
</details>


	<div>
		<h3>開館日</h3>
		<div id="calendar" class="calendar-wrap">

		</div>

	</div>

<script th:inline="javascript">
	//カレンダーの表示

	const date = new Date();
	const today = date.getDate();
	const currentMonth = date.getMonth();
	let displayMonth = currentMonth;

	//List
	const closeDates = /*[[${closeDates}]]*/null;

	function createCalendar(month) {
		//曜日
		const monthDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
		let calendarHTML = '<table border="1" class="calendar"><thead><tr>';

		for (let i = 0; i < 7; i++) {
			if (i === 0) {
				calendarHTML += `<th class="sun">${monthDays[i]}</th>`;
			} else if (i === 6) {
				calendarHTML += `<th class="sat">${monthDays[i]}</th>`;
			} else {
				calendarHTML += `<th>${monthDays[i]}</th>`;
			}
		}

		calendarHTML += '</tr></thead><tbody>';

		const thisYear = date.getFullYear() + Math.trunc(month / 12);
		const daysInMonth = new Date(date.getFullYear(), month + 1, 0).getDate();
		const firstDay = new Date(date.getFullYear(), month, 1).getDay();

		const daysInPrevMonth = new Date(date.getFullYear(), month, 0).getDate();

		let dayCount = 1;
		let prevDayCount = daysInPrevMonth - firstDay + 1;

		//LocalDateとの比較のための整形
		const yearAndMonth = String(thisYear) + '-'
			+ ('0' + String((month % 12) + 1)).slice(-2) + '-';

		for (let i = 0; i < 6; i++) {
			calendarHTML += '<tr>';

			for (let j = 0; j < 7; j++) {
				if (i === 0 && j < firstDay) {
					calendarHTML += `<td class="mute"></td>`;
					prevDayCount++;
				} else if (dayCount > daysInMonth) {
					let nextMonthDayCount = dayCount - daysInMonth;
					calendarHTML += `<td class="mute"></td>`;
					dayCount++;
				} else {

					let ymd = yearAndMonth + ('0' + String(dayCount)).slice(-2);


					calendarHTML += `<td class="date`;

					for (day of closeDates) {
						if (day.closedDate == ymd) {
							calendarHTML += ` closed`;
							break;
						}
					}


					// 今日の日付にclassを付ける
					if (dayCount == today) {
						calendarHTML += ` today`;
					}


					calendarHTML += `"><span class="dateNum">${dayCount}</span>`;

					calendarHTML += `</td>`;

					dayCount++;
				}
			}

			calendarHTML += '</tr>';

			if (dayCount > daysInMonth) {
				break;
			}
		}

		calendarHTML += '</tbody></table>';

		return calendarHTML;
	}

	document.getElementById('calendar').innerHTML = createCalendar(currentMonth);

</script>

<h1>貸出回数ランキング</h1>

<table border="1">
		<tr>
			<th>タイトル</th>
			<th>著者名</th>
			<th>出版社</th>
			<th>出版日</th>
			<th>貸出回数</th>
			<th>詳細</th>
		</tr>
		<tr th:each="item:${itemList}">
			<td th:text="${item.name}"></td>
			<td th:text="${item.author}"></td>
			<td th:text="${item.publisher}"></td>
			<td th:text="${item.publicationDate}"></td>
			<td th:text="${item.rentalNumber}"></td>
			<td>
				<form th:action="'/library/search/'+${item.id}"><button>詳細</button></form>
			</td>
		</tr>
	</table>

</body>



</html>